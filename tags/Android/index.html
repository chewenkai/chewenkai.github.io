<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><title>Tag: Android - Calvin</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#f7f7f7"><meta name="application-name" content="Kaka"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#f7f7f7"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Kaka"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="description"><meta property="og:type" content="blog"><meta property="og:title" content="Calvin"><meta property="og:url" content="https://chewenkai.github.io/"><meta property="og:site_name" content="Calvin"><meta property="og:description" content="description"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://chewenkai.github.io/img/og_image.png"><meta property="article:author" content="calvinche"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chewenkai.github.io"},"headline":"Calvin","image":["https://chewenkai.github.io/img/og_image.png"],"author":{"@type":"Person","name":"calvinche"},"publisher":{"@type":"Organization","name":"Calvin","logo":{"@type":"ImageObject","url":"https://chewenkai.github.io/img/logo.svg"}},"description":"description"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-72437521-5" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-72437521-5');</script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.0.0">
<style>.not-gallery-item { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .not-gallery-item > span { position: relative; z-index: 10; }  .not-gallery-item img, .not-gallery-item .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .not-gallery-item img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .not-gallery-item-fallback { color: inherit; } .not-gallery-item-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Calvin" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Calvin" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">Android</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-10T03:29:58.000Z" title="6/10/2019, 11:29:58 AM">2019-06-10</time></span><span class="level-item">7 minutes read (About 1033 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/uncategorized/%E8%AE%B0%E4%B8%80%E6%AC%A1overloadaggressively%E9%80%A0%E6%88%90%E7%9A%84%E5%B4%A9%E6%BA%83/">记一次overloadaggressively造成的崩溃</a></h1><div class="content"><p>将Kotlin版本从1.1.2-4升级到1.3.11后，发现打的release包开机就会崩溃：崩溃日志为</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: Unable to instantiate application com.tencent.sigma.patch.HotPatchApplication: java.lang.ClassNotFoundException: Didn<span class="string">'t find class "com.tencent.sigma.patch.HotPatchApplication" on path: DexPathList[[zip file "/data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk"],nativeLibraryDirectories=[/data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/lib/arm, /data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk!/lib/armeabi, /system/lib, /vendor/lib]]</span></span><br><span class="line"><span class="string">     at android.app.LoadedApk.makeApplication(LoadedApk.java:993)</span></span><br><span class="line"><span class="string">     at android.app.ActivityThread.handleBindApplication(ActivityThread.java:5801)</span></span><br><span class="line"><span class="string">     at android.app.ActivityThread.-wrap1(Unknown Source:0)</span></span><br><span class="line"><span class="string">     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1683)</span></span><br><span class="line"><span class="string">     at android.os.Handler.dispatchMessage(Handler.java:106)</span></span><br><span class="line"><span class="string">     at android.os.Looper.loop(Looper.java:173)</span></span><br><span class="line"><span class="string">     at android.app.ActivityThread.main(ActivityThread.java:6650)</span></span><br><span class="line"><span class="string">     at java.lang.reflect.Method.invoke(Native Method)</span></span><br><span class="line"><span class="string">     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span></span><br><span class="line"><span class="string">     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:818)</span></span><br><span class="line"><span class="string">  Caused by: java.lang.ClassNotFoundException: Didn'</span>t find class <span class="string">"com.tencent.sigma.patch.HotPatchApplication"</span> on path: DexPathList[[zip file <span class="string">"/data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk"</span>],nativeLibraryDirectories=[/data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/lib/arm, /data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk!/lib/armeabi, /system/lib, /vendor/lib]]</span><br><span class="line">     at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:125)</span><br><span class="line">     at java.lang.ClassLoader.loadClass(ClassLoader.java:379)</span><br><span class="line">     at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">     at android.app.Instrumentation.newApplication(Instrumentation.java:1088)</span><br><span class="line">     at android.app.LoadedApk.makeApplication(LoadedApk.java:987)</span><br><span class="line">     at android.app.ActivityThread.handleBindApplication(ActivityThread.java:5801)&nbsp;</span><br><span class="line">     at android.app.ActivityThread.-wrap1(Unknown Source:0)&nbsp;</span><br><span class="line">     at android.app.ActivityThread<span class="variable">$H</span>.handleMessage(ActivityThread.java:1683)&nbsp;</span><br><span class="line">     at android.os.Handler.dispatchMessage(Handler.java:106)&nbsp;</span><br><span class="line">     at android.os.Looper.loop(Looper.java:173)&nbsp;</span><br><span class="line">     at android.app.ActivityThread.main(ActivityThread.java:6650)&nbsp;</span><br><span class="line">     at java.lang.reflect.Method.invoke(Native Method)&nbsp;</span><br><span class="line">     at com.android.internal.os.RuntimeInit<span class="variable">$MethodAndArgsCaller</span>.run(RuntimeInit.java:547)&nbsp;</span><br><span class="line">     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:818)&nbsp;</span><br><span class="line"> 	Suppressed: java.io.IOException: Failed to open dex files from /data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk because: Failure to verify dex file <span class="string">'/data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk'</span>: Out-of-order annotation_element name_idx: 7150 <span class="keyword">then</span> 7150</span><br><span class="line">     at dalvik.system.DexFile.openDexFileNative(Native Method)</span><br><span class="line">     at dalvik.system.DexFile.openDexFile(DexFile.java:353)</span><br><span class="line">     at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:100)</span><br><span class="line">     at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:74)</span><br><span class="line">     at dalvik.system.DexPathList.loadDexFile(DexPathList.java:374)</span><br><span class="line">     at dalvik.system.DexPathList.makeDexElements(DexPathList.java:337)</span><br><span class="line">     at dalvik.system.DexPathList.&lt;init&gt;(DexPathList.java:157)</span><br><span class="line">     at dalvik.system.BaseDexClassLoader.&lt;init&gt;(BaseDexClassLoader.java:65)</span><br><span class="line">     at dalvik.system.PathClassLoader.&lt;init&gt;(PathClassLoader.java:64)</span><br><span class="line">     at com.android.internal.os.ClassLoaderFactory.createClassLoader(ClassLoaderFactory.java:73)</span><br><span class="line">     at com.android.internal.os.ClassLoaderFactory.createClassLoader(ClassLoaderFactory.java:88)</span><br><span class="line">     at android.app.ApplicationLoaders.getClassLoader(ApplicationLoaders.java:69)</span><br><span class="line">     at android.app.ApplicationLoaders.getClassLoader(ApplicationLoaders.java:35)</span><br><span class="line">     at android.app.LoadedApk.createOrUpdateClassLoaderLocked(LoadedApk.java:695)</span><br><span class="line">     at android.app.LoadedApk.getClassLoader(LoadedApk.java:729)</span><br><span class="line">     at android.app.LoadedApk.getResources(LoadedApk.java:956)</span><br><span class="line">     at android.app.ContextImpl.createAppContext(ContextImpl.java:2282)</span><br><span class="line">     at android.app.ActivityThread.handleBindApplication(ActivityThread.java:5723)</span><br><span class="line">     		... 8 more</span><br></pre></td></tr></tbody></table></figure>



<p>乍一看，以为是HotPatchApplication被混淆的原因导致Class Not Found，于是尝试keep住HotPatchApplication这个类，但是发现问题依旧。于是又怀疑是前不久升级gradle对分包造成了影响，对apk中的dex文件进行分析，发现HotPatchApplication这个类稳稳的躺在第一个dex文件中。</p>
<p>后来又进行了以下的尝试：</p>
<p>​     1.尝试按顺序更改Kotlin版本，最后，当Kotlin版本为1.3.0时，发现问题出现了。  </p>
<p>​    2.另一个线索是当我打开Proguard时，那就是<code>minifyEnable true</code>，崩溃就出现了。</p>
<p>经过以上排查，基本确定了问题出在Kotlin和混淆的身上。最后发现上述日志中有一行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Suppressed: java.io.IOException: Failed to open dex files from /data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk because: Failure to verify dex file <span class="string">'/data/app/com.tencent.dreamreader-P2-qUIVdDrdEOhONvRwOtw==/base.apk'</span>: Out-of-order annotation_element name_idx: 7150 <span class="keyword">then</span> 7150</span><br></pre></td></tr></tbody></table></figure>

<p>这个报错是第一次见到，上网搜了下，最终定位在混淆时的一个参数身上：<code>-overloadaggressively</code></p>
<p>ProGuard官网解释：</p>
<blockquote>
<p>-overloadaggressively
Specifies to apply aggressive overloading while obfuscating. Multiple fields and methods can then get the same names, as long as their arguments and return types are different, as required by Java bytecode (not just their arguments, as required by the Java language). This option can make the processed code even smaller (and less comprehensible). Only applicable when obfuscating.</p>
</blockquote>
<p>可以看出，开启该选项可能把不同的方法或者变量混淆成相同的名字，这样会尽可能的减小代码体积。但是由于过于激进，造成了dex文件中有重复annotation_element，这个问题在编译和打包时并不会报错，只有在开启软件时才会发现。</p>
<p>至于为什么升级了Kotlin才有这个问题，猜测原因是新版本的kotlin中加入了Keep注释与Java的Keep注释同名造成的。</p>
<p><strong>解决办法：</strong></p>
<p>去掉混淆文件（proguard.txt）中的-overloadaggressively</p>
<p>参考：</p>
<p>https://stackoverflow.com/questions/56458360/app-crashed-when-r8-enabled-with-existing-proguard-settings</p>
<p>https://issuetracker.google.com/issues/129241209#comment11</p>
<p>https://stackoverflow.com/questions/51948250/failure-to-verify-dex-file-out-of-order-annotation-element-name-idx</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-03-11T01:32:41.000Z" title="3/11/2019, 9:32:41 AM">2019-03-11</time></span><span class="level-item">3 minutes read (About 466 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/uncategorized/%E5%88%9D%E8%AF%86viewpager2/">初识ViewPager2</a></h1><div class="content"><p>ViewPager2是Google于2019年2月7号发布的ViewPager的升级版本，目前最新版本是1.0.0-alpha01。ViewPager2主要解决了传统ViewPager中的几个问题：</p>
<ul>
<li>不支持从右到左布局</li>
<li>不支持纵向滚动</li>
<li>notifyDataSetChanged()有时不起作用的Bug</li>
</ul>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>查看ViewPager2内部代码可以看出，其实现原理是在其内部封装了一个RecyclerView，利用LinearLayoutManager+PagerSnapHelper实现了ViewPager的滚动效果以及对纵向滚动的支持。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ViewPager2</span> <span class="keyword">extends</span> <span class="title class_">ViewGroup</span> {</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(Context context, AttributeSet attrs)</span> {</span><br><span class="line">            mRecyclerView = <span class="keyword">new</span> <span class="title class_">RecyclerView</span>(context) {</span><br><span class="line">               ...</span><br><span class="line">            };</span><br><span class="line"></span><br><span class="line">            mLayoutManager = <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(context);</span><br><span class="line">            mRecyclerView.setLayoutManager(mLayoutManager);</span><br><span class="line">            setOrientation(context, attrs);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PagerSnapHelper</span>().attachToRecyclerView(mRecyclerView);</span><br><span class="line">            ...</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="目前存在的问题："><a href="#目前存在的问题：" class="headerlink" title="目前存在的问题："></a>目前存在的问题：</h3><p>由于直接使用的RecycleView实现，一些ViewPager的特性没有得到完全实现，官方指出了下面几个问题：</p>
<ul>
<li>不支持设置offscreen limit</li>
<li>与TabLayout的集成存在问题</li>
<li>FragmentStateAdapter还有稳定性问题</li>
<li>不支持设置pageWitch，默认100%/100%</li>
<li>不支持clipToPadding</li>
<li>不支持fakeDrag</li>
<li>设置page transformer时，不支持设置绘制顺序</li>
</ul>
<h3 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h3><p>其使用方法与传统ViewPager类似：</p>
<p>1.在模块gradle中添加依赖：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'androidx.viewpager2:viewpager2:1.0.0-alpha01'</span></span><br></pre></td></tr></tbody></table></figure>

<p>2.在Layout文件中布局，这里可以设置滚动方向:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;androidx.viewpager2.widget.ViewPager2</span><br><span class="line">        android:id=<span class="string">"@+id/viewPager2"</span></span><br><span class="line">        android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">        android:orientation=<span class="string">"vertical"</span> /&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>3.创建Adapter，ViewPager2使用FragmentStateAdapter来实现Fragment的管理：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ViewPager2Adapter</span> <span class="keyword">extends</span> <span class="title class_">FragmentStateAdapter</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ViewPager2Adapter</span><span class="params">(<span class="meta">@NonNull</span> FragmentManager fragmentManager)</span> {</span><br><span class="line">        <span class="built_in">super</span>(fragmentManager);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Fragment <span class="title function_">getItem</span><span class="params">(<span class="type">int</span> position)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleFragment</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemCount</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>4.应用Adapter:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viewPager2 = findViewById(R.id.viewpager2);</span><br><span class="line"><span class="type">ViewPager2Adapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewPager2Adapter</span>(getSupportFragmentManager());</span><br><span class="line">viewPager2.setAdapter(adapter);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>ViewPager2具有原生支持垂直方向滑动的特性，但是由于目前FragmentStateAdapter还有稳定性问题，以及设置page transformer时，不支持设置绘制顺序，在实际应用时还需要多进行修改和测试。建议等官方推出稳定版本后，再考虑接入。</p>
<p><strong>参考：</strong></p>
<p>[1] <a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/androidx/releases/viewpager2">https://developer.android.com/jetpack/androidx/releases/viewpager2</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/viewpager2/adapter/FragmentStateAdapter">https://developer.android.google.cn/reference/androidx/viewpager2/adapter/FragmentStateAdapter</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/viewpager2/widget/ViewPager2">https://developer.android.google.cn/reference/androidx/viewpager2/widget/ViewPager2</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://www.journaldev.com/26148/android-viewpager2">https://www.journaldev.com/26148/android-viewpager2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-03-07T15:43:35.000Z" title="3/7/2019, 11:43:35 PM">2019-03-07</time></span><span class="level-item">22 minutes read (About 3275 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/uncategorized/android-studio%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%A8%A1%E7%89%88-templates-%E5%88%9B%E5%BB%BA/">Android Studio的三种类型的模版(Templates)创建</a></h1><div class="content"><h2 id="Android-Studio的三种类型的模版-Templates-创建"><a href="#Android-Studio的三种类型的模版-Templates-创建" class="headerlink" title="Android Studio的三种类型的模版(Templates)创建"></a>Android Studio的三种类型的模版(Templates)创建</h2><p>如果说使用快捷键是程序员的刀🔪，那灵活的使用代码模版就应该是程序员的剑。</p>
<p>这里说的模版(Templates)，是指在使用开发创建类文件，甚至是某些代码块时，IDE自动按照规定的格式创建出类或代码的功能。如果类中有大量相似代码，使用模版可以极大的提高开发效率，降低出错概率。</p>
<p>下面我们看一下如何在Android Studio上使用<strong>模版</strong>，我将讲述三种模版的创建，分别是：</p>
<ul>
<li>使用<strong>Live Templates</strong>创建代码块模版</li>
<li>使用<strong>File and Code Templates</strong>创建类模版</li>
<li><strong>基于FreeMarker</strong>创建多文件模版</li>
</ul>
<h3 id="1-代码块模版"><a href="#1-代码块模版" class="headerlink" title="1.代码块模版"></a>1.代码块模版</h3><p>java中经常需要定义这样的静态常量：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_VALUE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>使用Live Templates后，就可以直接输入const就可以快速定义静态常量：</p>
<p><img src="https://s2.ax1x.com/2019/03/08/kxO5IP.png"></p>
<p>其设置方法是，打开File-&gt;Setting（⌘+,）,搜索“Live Templates”，打开如下的界面：</p>
<p><img src="https://s2.ax1x.com/2019/03/08/kxLON6.png"></p>
<p>其中，<em>1</em>指的是缩写和该缩写的描述；<em>2</em>中输入的是模版的内容；<em>3</em>中可以指定该模版应用生效的语言和场所，例如，可以限制该模版只应用到Java语言定义变量(declaration)的时候; <em>4</em>可以将模版中变化的部分定义为变量，如上图中的<code>${name}</code>和<code>${value}</code>     </p>
<p>上面例子中的const是默认的模版，你可以点击加号添加自己的模版，例如为kotlin定义一个tag常量的模版：</p>
<p><img src="https://s2.ax1x.com/2019/03/08/kxXswn.png"></p></div><a class="article-more button is-small is-size-7" href="/uncategorized/android-studio%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%A8%A1%E7%89%88-templates-%E5%88%9B%E5%BB%BA/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-02-01T12:05:07.000Z" title="2/1/2019, 8:05:07 PM">2019-02-01</time></span><span class="level-item">14 minutes read (About 2158 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/uncategorized/%E5%AF%B9%E4%BD%BF%E7%94%A8viewpager%E7%9A%84%E4%B8%80%E7%82%B9%E7%90%86%E8%A7%A3/">对使用ViewPager的一点理解</a></h1><div class="content"><p>大家都用过ViewPager吧😄，使用ViewPager时，需要给它配一个Adapter，通常我们要继承下面三个Adapter来，分别是：</p>
<p>———&gt;最基本的PagerAdapter</p>
<p>——————&gt;继承PagerAdapter的FragmentPagerAdapter</p>
<p>——————&gt;继承PagerAdapter的FragmentStatePagerAdapter</p>
<p>那么这三个Adapter有什么区别，我们应该怎么选择呢？</p>
<h3 id="1-关于PagerAdapter"><a href="#1-关于PagerAdapter" class="headerlink" title="1.关于PagerAdapter"></a>1.关于PagerAdapter</h3><p>首先，我们知道如果继承了PagerAdapter，需要我们实现下面两个方法:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the number of views available.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create the page for the given position.  The adapter is responsible</span></span><br><span class="line"><span class="comment"> * for adding the view to the container given here, although it only</span></span><br><span class="line"><span class="comment"> * must ensure this is done by the time it returns from</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #finishUpdate(ViewGroup)}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> container The containing View in which the page will be shown.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> position The page position to be instantiated.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Returns an Object representing the new page.  This does not</span></span><br><span class="line"><span class="comment"> * need to be a View, but can be some other container of the page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">instantiateItem</span><span class="params">(ViewGroup container, <span class="type">int</span> position)</span> {</span><br><span class="line">    <span class="keyword">return</span> instantiateItem((View) container, position);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>第一个是要告诉ViewPager一共有几个页面，第二个则是ViewPager需要加载页面了，你需要根据position创建不同的页面对象，这里通常是View对象。 </p>
<p>当然，如果你的ViewPager中内容比较复杂，需要用Fragment来自动管理其生命周期，那么可以使用FragmentPagerAdapter和FragmentStatePagerAdapter中的一种，那么他俩有什么区别呢？</p>
<p>首先我们看一下FragmentPagerAdapter的<code>instantiateItem</code>和<code>destroyItem</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> 	<span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">instantiateItem</span><span class="params">(ViewGroup container, <span class="type">int</span> position)</span> {</span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">final</span> <span class="type">long</span> <span class="variable">itemId</span> <span class="operator">=</span> getItemId(position);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Do we already have this fragment?</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> makeFragmentName(container.getId(), itemId);</span><br><span class="line">       <span class="type">Fragment</span> <span class="variable">fragment</span> <span class="operator">=</span> mFragmentManager.findFragmentByTag(name);</span><br><span class="line">       <span class="keyword">if</span> (fragment != <span class="literal">null</span>) {</span><br><span class="line">           <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Attaching item #"</span> + itemId + <span class="string">": f="</span> + fragment);</span><br><span class="line">           mCurTransaction.attach(fragment);</span><br><span class="line">       } <span class="keyword">else</span> {</span><br><span class="line">           fragment = getItem(position);</span><br><span class="line">           <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Adding item #"</span> + itemId + <span class="string">": f="</span> + fragment);</span><br><span class="line">           mCurTransaction.add(container.getId(), fragment,</span><br><span class="line">                   makeFragmentName(container.getId(), itemId));</span><br><span class="line">       }</span><br><span class="line">      ...</span><br><span class="line">       <span class="keyword">return</span> fragment;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyItem</span><span class="params">(ViewGroup container, <span class="type">int</span> position, Object object)</span> {</span><br><span class="line">       <span class="keyword">if</span> (mCurTransaction == <span class="literal">null</span>) {</span><br><span class="line">           mCurTransaction = mFragmentManager.beginTransaction();</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Detaching item #"</span> + getItemId(position) + <span class="string">": f="</span> + object</span><br><span class="line">               + <span class="string">" v="</span> + ((Fragment)object).getView());</span><br><span class="line">       mCurTransaction.detach((Fragment)object);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getItemId</span><span class="params">(<span class="type">int</span> position)</span> {</span><br><span class="line">       <span class="keyword">return</span> position;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">makeFragmentName</span><span class="params">(<span class="type">int</span> viewId, <span class="type">long</span> id)</span> {</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"android:switcher:"</span> + viewId + <span class="string">":"</span> + id;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p>可以看出<code>instantiateItem</code>方法在添加Fragment时，会带一个Fragment的名字，其实就是Tag：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCurTransaction.add(container.getId(), fragment, makeFragmentName(container.getId(), itemId));</span><br></pre></td></tr></tbody></table></figure>

<p>这个Tag是根据一定规则从<code>makeFragmentName</code>中获得的，这里唯一变化的就是id，默认的id可从getItemId(position)中看到，就是当前的position，保证了每个fragment的tag是唯一的。</p>
<p>当ViewPager通过<code>instantiateItem</code>获取Fragment的时候，会先根据之前设置的Tag找一下这个Fragment存不存在：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mFragmentManager.findFragmentByTag(name)</span><br></pre></td></tr></tbody></table></figure>

<p>根据获取到的Fragment有两种添加方式，如果根据Tag找到了之前存在的Fragment，就attach上去：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCurTransaction.attach(fragment);</span><br></pre></td></tr></tbody></table></figure>

<p>如果没找到，那就把新创建的Fragment add上去:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCurTransaction.add(container.getId(), fragment, makeFragmentName(container.getId(), itemId));</span><br></pre></td></tr></tbody></table></figure>

<p>当不用这个Fragment的时，会调用<code>destroyItem</code>方法，可以看到这里是detach掉了Fragment，并没有销毁。</p>
<p>综上，一个页面只会创建一次，创建时根据当前的position给Fragment设置一个Tag，当不需要时只是把Fragmetn detach掉，并不会销毁，下次需要时通过Tag复用Fragment。</p>
<p>所以，如果你有大量的Fragment要展示，FragmentPagerAdapter会持有每一个Fragment不释放，最终走向OOM。</p>
<p>所以，无论使用PagerAdapter还是FragmentPagerAdapter，有多少页面，就会创建多少页面对象，页面很多的情况下，会非常占用内存，虽然这样，但是它们也有各自的应用场景，例如，App的首次安装的启动引导页面个数是固定的，而且如果比较复杂，通常做成Fragment，这时使用FragmentPagerAdapter较为合适；而如果页面中有需要自动轮播卡片的地方，则可以使用PagerAdapter实现，因为其页面一般都是View，结构简单，数量也是固定的。</p>
<p>那如果我需要做一个可以无限滑动的卡片，就需要用到FragmentStatePagerAdapter了，我们看一下FragmentStatePagerAdapter的<code>instantiateItem</code>和<code>destroyItem</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the Fragment associated with a specified position.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> Fragment <span class="title function_">getItem</span><span class="params">(<span class="type">int</span> position)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">instantiateItem</span><span class="params">(ViewGroup container, <span class="type">int</span> position)</span> {</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mCurTransaction == <span class="literal">null</span>) {</span><br><span class="line">        mCurTransaction = mFragmentManager.beginTransaction();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">Fragment</span> <span class="variable">fragment</span> <span class="operator">=</span> getItem(position);</span><br><span class="line">    <span class="keyword">while</span> (mFragments.size() &lt;= position) {</span><br><span class="line">        mFragments.add(<span class="literal">null</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line"> 	...</span><br><span class="line">    mCurTransaction.add(container.getId(), fragment);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fragment;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyItem</span><span class="params">(ViewGroup container, <span class="type">int</span> position, Object object)</span> {</span><br><span class="line">    <span class="type">Fragment</span> <span class="variable">fragment</span> <span class="operator">=</span> (Fragment) object;</span><br><span class="line">    ...</span><br><span class="line">    mCurTransaction.remove(fragment);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，FragmentStatePagerAdapter在初始化页面时，通过getItem这个抽象方法来获得Fragment，并将其add到容器里，而不用的时候直接remove掉，这样就不会一直占用Fragment，可以实现无限滑动，唯一关心的就是在getItem中创建一个Fragment就可以了。</p>
<p>以上就是我对三种PagerAdapter的简单理解。在使用ViewPager的过程中，除了adapter的选择，还需要到了下面的问题。</p>
<h3 id="2-常见的两个问题小析"><a href="#2-常见的两个问题小析" class="headerlink" title="2.常见的两个问题小析"></a>2.常见的两个问题小析</h3><h5 id="1-notifyDataSetChanged-后页面没有刷新的问题"><a href="#1-notifyDataSetChanged-后页面没有刷新的问题" class="headerlink" title="1.notifyDataSetChanged()后页面没有刷新的问题"></a>1.notifyDataSetChanged()后页面没有刷新的问题</h5><p>这个问题主要是由于当数据更新时，ViewPager会调用<code>dataSetChanged</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">dataSetChanged</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// This method only gets called if our observer is attached, so mAdapter is non-null.</span></span><br><span class="line"></span><br><span class="line">  	...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mItems.size(); i++) {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">ii</span> <span class="operator">=</span> mItems.get(i);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newPos</span> <span class="operator">=</span> mAdapter.getItemPosition(ii.object);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newPos == PagerAdapter.POSITION_UNCHANGED) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newPos == PagerAdapter.POSITION_NONE) {</span><br><span class="line">            mItems.remove(i);</span><br><span class="line">            i--;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isUpdating) {</span><br><span class="line">                mAdapter.startUpdate(<span class="built_in">this</span>);</span><br><span class="line">                isUpdating = <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            mAdapter.destroyItem(<span class="built_in">this</span>, ii.position, ii.object);</span><br><span class="line">            needPopulate = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mCurItem == ii.position) {</span><br><span class="line">                <span class="comment">// Keep the current item in the valid range</span></span><br><span class="line">                newCurrItem = Math.max(<span class="number">0</span>, Math.min(mCurItem, adapterCount - <span class="number">1</span>));</span><br><span class="line">                needPopulate = <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">     ...</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>这个方法会调用adapter的getItemPosition()来获得object的位置情况是否发生变化，如果不发生变化就不更新了，如果而这个方法默认是返回的就是POSITION_UNCHANGED：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when the host view is attempting to determine if an item's position</span></span><br><span class="line"><span class="comment"> * has changed. Returns {<span class="doctag">@link</span> #POSITION_UNCHANGED} if the position of the given</span></span><br><span class="line"><span class="comment"> * item has not changed or {<span class="doctag">@link</span> #POSITION_NONE} if the item is no longer present</span></span><br><span class="line"><span class="comment"> * in the adapter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The default implementation assumes that items will never</span></span><br><span class="line"><span class="comment"> * change position and always returns {<span class="doctag">@link</span> #POSITION_UNCHANGED}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object Object representing an item, previously returned by a call to</span></span><br><span class="line"><span class="comment"> *               {<span class="doctag">@link</span> #instantiateItem(View, int)}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> object's new position index from [0, {<span class="doctag">@link</span> #getCount()}),</span></span><br><span class="line"><span class="comment"> *         {<span class="doctag">@link</span> #POSITION_UNCHANGED} if the object's position has not changed,</span></span><br><span class="line"><span class="comment"> *         or {<span class="doctag">@link</span> #POSITION_NONE} if the item is no longer present.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemPosition</span><span class="params">(Object object)</span> {</span><br><span class="line">    <span class="keyword">return</span> POSITION_UNCHANGED;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>所以要想每次刷新都让页面更新，需要在adapter中重写getItemPosition方法，并返回POSITION_NONE就可以了：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemPosition</span><span class="params">(Object object)</span> {</span><br><span class="line">    <span class="keyword">return</span> POSITION_NONE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="2-初始化数据时不会调用OnPageChangeListener"><a href="#2-初始化数据时不会调用OnPageChangeListener" class="headerlink" title="2.初始化数据时不会调用OnPageChangeListener"></a>2.初始化数据时不会调用OnPageChangeListener</h5><p>相信大家都遇到过这种情况，就是ViewPager初始化时并不会调用OnPageChangeListener，所以很多时候我们都是手动调用第一页的onPageSelected方法:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ViewPager.<span class="type">OnPageChangeListener</span> <span class="variable">onPageChangeListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewPager</span>.OnPageChangeListener() {</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageScrolled</span><span class="params">(<span class="type">int</span> position, <span class="type">float</span> positionOffset, <span class="type">int</span> positionOffsetPixels)</span> {</span><br><span class="line"></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageSelected</span><span class="params">(<span class="type">int</span> position)</span> {</span><br><span class="line"></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageScrollStateChanged</span><span class="params">(<span class="type">int</span> state)</span> {</span><br><span class="line"></span><br><span class="line">      }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">OnCreate</span><span class="params">()</span>{</span><br><span class="line">      ...</span><br><span class="line">      mViewPager.setOnPageChangeListener(onPageChangeListener);</span><br><span class="line">onPageChangeListener.onPageSelected(<span class="number">0</span>);  <span class="comment">// 手动调用第一页</span></span><br><span class="line">      ...</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p>但是如果如果你使用的是FragmentPagerAdapter时，会发现在onPageSelected(0)时，会发现Fragment还没有创建成功，这时候会出现NPE(NullPointerException)。所以这时候可以这样写：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mViewPager.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>(){</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        onPageChangeListener.onPageSelected(<span class="number">0</span>);  <span class="comment">// 手动调用第一页</span></span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>这样就会在viewpager的UI事件队列完成后处理onPageSelected方法的内容，这个时候Fragment已经好了。</p>
<p>但是，虽然这样，讲要进行的工作交给post会打乱同步时序，让要做的事充满了不确定性，我不知道它什么时候能调用onPageSelected方法。而且这样做也存在另外一个问题，当使用notifyDataSetChanged()刷新数据时，还是不会调用当前页的onPageSelected来更新当前页面，所以我更倾向于下面这种方法:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPagerAdapter</span> <span class="keyword">extends</span> <span class="title class_">FragmentStatePagerAdapter</span> {</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> Object lastPrimaryItem;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> OnPageSwitchListener onPageSwitchListener;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPagerAdapter</span><span class="params">(FragmentManager fm, OnPageSwitchListener onPageSwitchListener)</span> {</span><br><span class="line">        <span class="built_in">super</span>(fm);</span><br><span class="line">        <span class="built_in">this</span>.onPageSwitchListener = onPageSwitchListener;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrimaryItem</span><span class="params">(ViewGroup container, <span class="type">int</span> position, Object object)</span> {</span><br><span class="line">        <span class="built_in">super</span>.finishUpdate(container);</span><br><span class="line">        <span class="built_in">super</span>.setPrimaryItem(container, position, object);</span><br><span class="line">        <span class="keyword">if</span> (object == lastPrimaryItem) {</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// setPrimaryItem会多次调用，过滤掉多余的调用</span></span><br><span class="line">        }</span><br><span class="line">        lastPrimaryItem = object;</span><br><span class="line">        <span class="type">MyFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> (MyFragment)object;</span><br><span class="line">        <span class="keyword">if</span> (onPageSwitchListener != <span class="literal">null</span> &amp;&amp; fragment != <span class="literal">null</span>) {</span><br><span class="line">            onPageSwitchListener.onPageSwitch(position, fragment);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finishUpdate</span><span class="params">(ViewGroup container)</span> {</span><br><span class="line">		<span class="comment">// 这里将finishUpdate放到setPrimaryItem之前执行，见上面的方法👆</span></span><br><span class="line">        <span class="comment">// 原因是finishUpdate后的Fragment才算正式可以用了</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnPageSwitchListener</span>{</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onPageSwitch</span><span class="params">(<span class="type">int</span> position, MyFragment fragment)</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">MyPagerAdapter</span>.OnPageSwitchListener{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageSwitch</span><span class="params">(<span class="type">int</span> position, MyFragment fragment)</span> {</span><br><span class="line">    	<span class="comment">// Do whatever you like here. :)</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>简单说就是，PagerAdapter中有一个重要的方法叫<code>setPrimaryItem</code>，当一个页面显示的时候都会调用这个方法（多次），通过一些简单的处理，可以实现与mViewPager.setOnPageChangeListener()类似的功能，这样就不用每次调用onPageChangeListener.onPageSelected(0)或者使用Post操作了。</p>
<p>以上分析较为肤浅，有问题欢迎指正、补充，谢谢🙏</p>
<p>参考</p>
<p>[1] https://stackoverflow.com/questions/16074058/onpageselected-doesnt-work-for-first-page</p>
<p>[2] https://stackoverflow.com/questions/11794269/onpageselected-isnt-triggered-when-calling-setcurrentitem0</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-12-26T12:49:46.000Z" title="12/26/2018, 8:49:46 PM">2018-12-26</time></span><span class="level-item">4 minutes read (About 629 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/uncategorized/%E5%9D%91-textview%E5%90%8C%E6%97%B6%E4%BD%BF%E7%94%A8maxlines-1%E5%92%8Cellipsize%E6%97%B6%E5%81%B6%E5%8F%91%E5%B4%A9%E6%BA%83/">坑--TextView同时使用maxLines=1和ellipsize时偶发崩溃</a></h1><div class="content"><p>今天发现项目的报错记录中排名第一的是<code>ArrayIndexOutOfBoundsException</code>错误，影响用户84，发生次数129。</p>
<p>报错堆栈如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> android.text.StaticLayout.getLineTop(StaticLayout.java:<span class="number">878</span>)</span><br><span class="line"><span class="number">2</span> android.widget.TextView.getExtendedPaddingTop(TextView.java:<span class="number">1966</span>)</span><br><span class="line"><span class="number">3</span> android.widget.TextView.bringTextIntoView(TextView.java:<span class="number">7291</span>)</span><br><span class="line"><span class="number">4</span> android.widget.TextView.onPreDraw(TextView.java:<span class="number">5107</span>)</span><br><span class="line"><span class="number">5</span> android.view.ViewTreeObserver.dispatchOnPreDraw(ViewTreeObserver.java:<span class="number">944</span>)</span><br><span class="line"><span class="number">6</span> android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:<span class="number">2348</span>)</span><br><span class="line"><span class="number">7</span> android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:<span class="number">1292</span>)</span><br><span class="line"><span class="number">8</span> android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:<span class="number">6598</span>)</span><br><span class="line"><span class="number">9</span> android.view.Choreographer$CallbackRecord.run(Choreographer.java:<span class="number">800</span>)</span><br><span class="line"><span class="number">10</span> android.view.Choreographer.doCallbacks(Choreographer.java:<span class="number">603</span>)</span><br><span class="line"><span class="number">11</span> android.view.Choreographer.doFrame(Choreographer.java:<span class="number">572</span>)</span><br><span class="line"><span class="number">12</span> android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:<span class="number">786</span>)</span><br><span class="line"><span class="number">13</span> android.os.Handler.handleCallback(Handler.java:<span class="number">815</span>)</span><br><span class="line"><span class="number">14</span> android.os.Handler.dispatchMessage(Handler.java:<span class="number">104</span>)</span><br><span class="line"><span class="number">15</span> android.os.Looper.loop(Looper.java:<span class="number">194</span>)</span><br><span class="line"><span class="number">16</span> android.app.ActivityThread.main(ActivityThread.java:<span class="number">5682</span>)</span><br><span class="line"><span class="number">17</span> java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">18</span> java.lang.reflect.Method.invoke(Method.java:<span class="number">372</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>从错误堆栈里并没有找到特别有用的信息。</p>
<p>于是去看了下报错的设备信息：</p>
<p>| 机型设备 Top 5        | 系统版本 Top 5                  |
| ——————— | ——————————- |
| 华为 TIT-TL00  11.26% | Android 5.1,level 22   31.40%   |
| 三星 GT-I908   26.48% | Android 4.1.2,level 16   20.48% |
| 荣耀 CUN AL00   6.14% | Android 4.0.4,level 15   10.92% |
| 华为 TAG-TL00   5.46% | Android 7.0   8.19%             |
| HTC T327T   4.44%     | Android 4.0.3,level 15   7.85%  |</p>
<p>可谓是五花八门，看来也不是特定机型或者特定系统的问题。</p>
<p>从日志和设备信息都分析不出问题，只能靠google了，通过不断的搜索，渐渐发现类似的崩溃跟TextView的两个属性有关系，分别是:</p>
<ul>
<li>Android:maxLines</li>
<li>Android:ellipsize</li>
</ul>
<p>根据查询的信息，得出了下面的结论：</p>
<p>如果同时设置了ellipsize和maxLine=1,就会在某些机型上产生崩溃（不是必先），报ArrayIndexOutOfBoundsException的异常。解决办法就是将maxLine=1换成已经废弃的singleLine=true。这是Android系统的一个bug，目前还没有解决。</p>
<p>下面查询到的相关记录：</p>
<p>If you try to use <code>maxLines=1</code> with <code>ellipsize</code>, you shall get the following lint error (refer to <a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/36950033">this discussion</a>)</p>
<blockquote>
<p>Combining ellipsize and maxLines=1 can lead to crashes on some devices. Earlier versions of lint recommended replacing singleLine=true with maxLines=1 but that should not be done when using ellipsize</p>
</blockquote>
<p>来源：https://code.luasoftware.com/tutorials/android/android-textview-singleline-with-ellipsis/</p>
<hr>
<p>问题 Crash when using ellipsize=”start” (Jelly Bean) 的回复</p>
<p>ri…@gmail.com <a href="mailto:ri...@gmail.com">ri...@gmail.com</a> <a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/36950033#comment3">#3</a>Jul 12, 2012 08:17AM </p>
<p><strong>I do notice that changing android:lines=”1” to android:singleLine=”true” causes the crash not to happen.</strong></p>
<p>来源:https://issuetracker.google.com/issues/36950033</p>
<hr>
<p>I faced what I suspect is the same problem in my own app. For me, it was happening because I was using <code>android:ellipsize="start"</code> <strong>without</strong> also using <code>android:singleLine="true"</code>.</p>
<p>We had switched all of our <code>android:singleLine="true"</code> attributes to the recommended <code>android:maxLines="1"</code>, but it turns out that there’s a bug in how the system calculates the ellipsis that is triggered if <code>singleLine</code> isn’t present.</p>
<p>So I believe you can solve this issue by simply adding <code>android:singleLine="true"</code> to your <code>TextView</code>s that are using <code>ellipsize</code> attrs.</p>
<p>来源：https://stackoverflow.com/questions/45487427/crashlytics-reporting-multiples-issues-for-textview-makesinglelayout</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-10-28T03:09:47.000Z" title="10/28/2018, 11:09:47 AM">2018-10-28</time></span><span class="level-item"><a class="link-muted" href="/categories/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a></span><span class="level-item">13 minutes read (About 1927 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/%E5%8E%9F%E6%9D%A5%E6%88%91%E6%A0%B9%E6%9C%AC%E4%B8%8D%E4%BC%9A%E7%94%A8android-studio/">原来我根本不会用Android Studio</a></h1><div class="content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在工作中解锁了一些使用Android Studio的技巧，在这里记录一下。</p>
<h3 id="1-为什么明明我的电脑剩余那么多内存，用Android-Studio打开多个工程后就开始卡顿了呢？"><a href="#1-为什么明明我的电脑剩余那么多内存，用Android-Studio打开多个工程后就开始卡顿了呢？" class="headerlink" title="1. 为什么明明我的电脑剩余那么多内存，用Android Studio打开多个工程后就开始卡顿了呢？"></a>1. 为什么明明我的电脑剩余那么多内存，用Android Studio打开多个工程后就开始卡顿了呢？</h3><p>有一次在使用Android stuido的时候发现会卡顿无比，滚动鼠标都卡，但我的机器明明配置很高，系统剩余的内存也很多啊。</p>
<p>于是，打开<strong>内存指示器</strong>，查看Android Studio的内存使用情况：</p>
<p><code>打开设置 -&gt; Appearance -&gt; Window Options -&gt; Show memory indicator </code></p>
<img src="/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/%E5%8E%9F%E6%9D%A5%E6%88%91%E6%A0%B9%E6%9C%AC%E4%B8%8D%E4%BC%9A%E7%94%A8android-studio/open_memory_indicator.png" class="" title="image"> 

<p>勾选了Show memory indicator 之后，就可以在Android Studio的右下角看到内存指示器了：</p>
<img src="/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/%E5%8E%9F%E6%9D%A5%E6%88%91%E6%A0%B9%E6%9C%AC%E4%B8%8D%E4%BC%9A%E7%94%A8android-studio/indicator.png" class="" title="indicator">

<p>双击指示器可以手动进行GC操作。这里显示的就是Android Studio占用的内存大小（左）和分配给Android Studio使用的最大内存（右）。如果发现占用内存基本上快要等于分配的最大内存的时候，说明需要分配更多的内存给Android Studio了。当时我的机器显示的是<code>1020/1024M</code>，这应该就是其默认分配的内存大小，基本上分配的内存已经快要用完了，这也就是为啥明明电脑内存剩余很多，但是Android Studio却很卡顿的原因。</p>
<p>于是，通过下面步骤来提高分配给Android的内存：</p>
<p>打开菜单<code>Help-&gt;Edit Custom VM Options</code>，这时，会在新窗口打开一个<code>studo.vmoptions</code>文件（如果之前没有，会新创建一个），在打开的文件中输入下面代码配置虚拟机堆栈的最大分配内存：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx4096m</span><br></pre></td></tr></tbody></table></figure>
<p>这里可以根据自己机器的内存大小，对Android Studio进行配置，配置完成后，重启Android Studio，看到右下角的内存指示器显示的最大分配内存已经发生了变化，就说明生效了。</p></div><a class="article-more button is-small is-size-7" href="/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/%E5%8E%9F%E6%9D%A5%E6%88%91%E6%A0%B9%E6%9C%AC%E4%B8%8D%E4%BC%9A%E7%94%A8android-studio/#more">Read more</a></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="calvinche"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">calvinche</p><p class="is-size-6 is-block">Android Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Center of the universe.</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">39</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">19</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/chewenkai" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/chewenkai"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Resum" href="https://github.com/chewenkai"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="http://gousbookstore.site:8000/ui/#!/downloading" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Downloader</span></span><span class="level-right"><span class="level-item tag">gousbookstore.site</span></span></a></li><li><a class="level is-mobile" href="http://gousbookstore.site:8000/apps/dashboard/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Driver</span></span><span class="level-right"><span class="level-item tag">gousbookstore.site</span></span></a></li><li><a class="level is-mobile" href="http://gousbookstore.site:2342/library/browse" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Photos</span></span><span class="level-right"><span class="level-item tag">gousbookstore.site</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">学习</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%97%A5%E5%B8%B8%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">日常总结</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%97%A5%E5%B8%B8%E6%B1%87%E6%8A%A5/"><span class="level-start"><span class="level-item">日常汇报</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/"><span class="level-start"><span class="level-item">日常记录</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/"><span class="level-start"><span class="level-item">面试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="level-start"><span class="level-item">数据结构</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-03-15T11:21:28.000Z">2020-03-15</time></p><p class="title"><a href="/uncategorized/%E6%AF%8F%E6%97%A5%E5%8D%95%E8%AF%8D%E8%AE%A1%E5%88%92/">每日单词计划</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-08-06T09:48:49.000Z">2019-08-06</time></p><p class="title"><a href="/uncategorized/git%E4%BF%9D%E5%91%BD%E5%A4%A7%E5%85%A8/">Git保命大全</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-06-10T03:29:58.000Z">2019-06-10</time></p><p class="title"><a href="/uncategorized/%E8%AE%B0%E4%B8%80%E6%AC%A1overloadaggressively%E9%80%A0%E6%88%90%E7%9A%84%E5%B4%A9%E6%BA%83/">记一次overloadaggressively造成的崩溃</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-03-11T01:32:41.000Z">2019-03-11</time></p><p class="title"><a href="/uncategorized/%E5%88%9D%E8%AF%86viewpager2/">初识ViewPager2</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-03-07T15:43:35.000Z">2019-03-07</time></p><p class="title"><a href="/uncategorized/android-studio%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%A8%A1%E7%89%88-templates-%E5%88%9B%E5%BB%BA/">Android Studio的三种类型的模版(Templates)创建</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">August 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">June 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">February 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">December 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">October 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">July 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/05/"><span class="level-start"><span class="level-item">May 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">April 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">March 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/01/"><span class="level-start"><span class="level-item">January 2015</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/01/"><span class="level-start"><span class="level-item">January 2014</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/01/"><span class="level-start"><span class="level-item">January 2013</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Andoird/"><span class="tag">Andoird</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Demo/"><span class="tag">Demo</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/English/"><span class="tag">English</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MacOS/"><span class="tag">MacOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/StarDict/"><span class="tag">StarDict</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Study/"><span class="tag">Study</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VIM/"><span class="tag">VIM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VirtualBox/"><span class="tag">VirtualBox</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8A%A5%E5%91%8A/"><span class="tag">报告</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8A%BD%E6%A0%B7%E7%9B%91%E7%9D%A3%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/"><span class="tag">抽样监督管理系统</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8E%92%E5%BA%8F/"><span class="tag">排序</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%B8%B8%E6%80%BB%E7%BB%93/"><span class="tag">日常总结</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/"><span class="tag">日常记录</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%89%9B%E5%AE%A2/"><span class="tag">牛客</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Calvin" height="28"></a><p class="is-size-7"><span>&copy; 2023 calvinche</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>